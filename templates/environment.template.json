{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "environmentName": {
      "type": "string",
      "metadata": {
        "description": "Abbreviated name for the environment, eg: AT, TEST, PP, PRD"
      }
    },
    "sharedManagementResourceGroup": {
      "type": "string",
      "metadata": {
        "description": "Name of the shared management resource group"
      }
    },
    "sharedKeyVaultName": {
      "type": "string",
      "metadata": {
        "description": "Name of the shared Key Vault for storing the SQL password"
      }
    },
    "sharedKeyVaultId": {
      "type": "string",
      "metadata": {
        "description": "This is necessary because the 'dependsOn' in the subscription template is not waiting for the keyvault to deploy"
      }
    },
    "sqlServerAdminPasswordSecretName": {
      "type": "string",
      "metadata": {
        "description": "The name of the Key Vault secret which contains the SQL Admin password for this environment"
      }
    },
    "sqlServerActiveDirectoryAdminLogin": {
      "type": "string",
      "metadata": {
        "description": "The active directory admin that will be assigned to the sql server"
      }
    },
    "sqlServerActiveDirectoryAdminObjectId": {
      "type": "string",
      "metadata": {
        "description": "The object id of the active directory admin that will be assigned to the sql server"
      }
    },
    "threatDetectionEmailAddress": {
      "type": "string",
      "metadata": {
        "description": "The email address that threat alerts will be sent to"
      }
    },
    "databaseConfiguration": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Configuration object which describes the structure of failovergroups"
      }
    },
    "virtualNetworkAddressSpacePrefix": {
      "type": "string",
      "metadata": {
        "description": "Virtual network address prefix for the environment vnet"
      }
    },
    "virtualNetworkDeploy": {
      "type": "string",
      "metadata": {
        "description": "Deploys the Virtual Network and deletes all subnets if Enabled https://github.com/Azure/azure-quickstart-templates/issues/2786"
      }
    },
    "gatewaySubnetCount": {
      "type": "int",
      "defaultValue": 1,
      "maxValue": 1,
      "metadata": {
        "description": "The number of gateway subnets to provision"
      }
    },
    "managementSubnetCount": {
      "type": "int",
      "defaultValue": 1,
      "maxValue": 1,
      "metadata": {
        "description": "The number of management subnets to provision"
      }
    },
    "frontendSubnetCount": {
      "type": "int",
      "defaultValue": 1,
      "maxValue": 5,
      "metadata": {
        "description": "The number of shared frontend app subnets to provision."
      }
    },
    "backendSubnetCount": {
      "type": "int",
      "defaultValue": 1,
      "maxValue": 5,
      "metadata": {
        "description": "The number of shared backend app subnets to provision."
      }
    },
    "sharedWorkerSubnetCount": {
      "type": "int",
      "defaultValue": 1,
      "maxValue": 5,
      "metadata": {
        "description": "The number of shared worker app subnets to provision."
      }
    },
    "sharedSqlServerSubnetCount": {
      "type": "int",
      "defaultValue": 1,
      "maxValue": 1,
      "metadata": {
        "description": "The number of shared sql server subnets to provision."
      }
    },
    "sharedKeyVaultSubnetCount": {
      "type": "int",
      "defaultValue": 1,
      "maxValue": 1,
      "metadata": {
        "description": "The number of shared kevault subnets to provision."
      }
    },
    "firewallsNsgName": {
      "type": "string",
      "defaultValue": "Disabled",
      "metadata": {
        "description": "Name of the firewall NSG to be associated to the gateway subnet gw-sn-0"
      }
    },
    "frontEndAppServicePlanSku": {
      "type": "object",
      "defaultValue": {
        "tier": "Standard",
        "size": "2",
        "instances": 2
      },
      "metadata": {
        "description": "An object representing the sku of the app service plan."
      }
    },
    "backEndAppServicePlanSku": {
      "type": "object",
      "defaultValue": {
        "tier": "Standard",
        "size": "2",
        "instances": 2
      },
      "metadata": {
        "description": "An object representing the sku of the app service plan."
      }
    },
    "sharedWorkerAppServicePlanSku": {
      "type": "object",
      "defaultValue": {
        "tier": "Standard",
        "size": "1",
        "instances": 1
      },
      "metadata": {
        "description": "An object representing the sku of the app service plan."
      }
    },
    "sharedStorageAccountContainerArray": {
      "type": "array",
      "metadata": {
        "description": "An array of the blob container names to deploy to the shared storage account."
      }
    },
    "logAnalyticsWorkspaceName": {
      "type": "string"
    },
    "logAnalyticsWorkspaceResourceGroupName": {
      "type": "string"
    },
    "externalSqlServerPrivateEndpoints": {
      "type": "object",
      "metadata": {
        "description": "An object of the external SQL Server resource ids to create private endpoints"
      }
    }
  },
  "variables": {
    "deploymentUrlBase": "https://raw.githubusercontent.com/SkillsFundingAgency/das-platform-building-blocks/master/templates/",
    "sharedDeploymentUrlBase": "https://raw.githubusercontent.com/SkillsFundingAgency/das-shared-infrastructure/master/",
    "environmentName": "[toLower(parameters('environmentName'))]",
    "resourceNamePrefix": "[toLower(concat('das-', variables('environmentName'),'-shared'))]",
    "sharedFrontEndAppServicePlanName": "[concat(variables('resourceNamePrefix'),'fe-asp')]",
    "sharedBackEndAppServicePlanName": "[concat(variables('resourceNamePrefix'),'be-asp')]",
    "sharedWorkerAppServicePlanName": "[concat(variables('resourceNamePrefix'),'wkr-asp')]",
    "firewallsResourceGroup": "[toLower(concat('das-', variables('environmentName'),'-firewall-rg'))]",
    "serviceBusNamespaceName": "[concat(variables('resourceNamePrefix'),'-ns')]",
    "redisCacheName": "[concat(variables('resourceNamePrefix'),'-rds')]",
    "cdnProfileName": "[concat(variables('resourceNamePrefix'),'-cdn')]",
    "eventHubNamespaceName": "[concat(variables('resourceNamePrefix'),'-eh')]",
    "configurationStorageName": "[concat(replace(variables('resourceNamePrefix'), '-',''), 'configstr')]",
    "sharedARMStorageName": "[concat(replace(variables('resourceNamePrefix'), '-',''), 'str')]",
    "sqlServerLocationMap": {
      "primary": {
        "location": "westeurope",
        "nameSuffix": "we"
      },
      "secondary": {
        "location": "northeurope",
        "nameSuffix": "ne"
      }
    },
    "sqlServerMinimalTlsVersion": "1.2",
    "baseSqlServerName": "[toLower(concat('das-',variables('environmentName'),'-shared-sql'))]",
    "deployFailoverGroups": "[contains(createArray('pp', 'prd') , toLower(variables('environmentName')))]",
    "primarySQLServerName": "[toLower(concat(variables('baseSQLServerName'), '-', variables('sqlServerLocationMap').primary.nameSuffix))]",
    "secondarySQLServerName": "[toLower(concat(variables('baseSQLServerName'), '-', variables('sqlServerLocationMap').secondary.nameSuffix))]",
    "sqlServerPrivateDnsZoneName": "privatelink.database.windows.net",
    "keyVaultPrivateDnsZoneName": "privatelink.vaultcore.azure.net",
    "virtualNetworkName": "[concat(variables('resourceNamePrefix'),'-vnet')]",
    "subnetServiceEndpointList": [
      "Microsoft.Web",
      "Microsoft.Sql",
      "Microsoft.Storage",
      "Microsoft.AzureCosmosDB",
      "Microsoft.KeyVault"
    ],
    "envrionmentExternalSqlServerPrivateEndpoints": "[parameters('externalSqlServerPrivateEndpoints')[toUpper(variables('environmentName'))]]"
  },
  "resources": [
    {
      "apiVersion": "2017-05-10",
      "name": "[concat('virtual-network-west-europe-', variables('environmentName'))]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('sharedDeploymentUrlBase'),'templates/network.template.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "virtualNetworkName": {
            "value": "[variables('virtualNetworkName')]"
          },
          "virtualNetworkAddressSpacePrefix": {
            "value": "[parameters('virtualNetworkAddressSpacePrefix')]"
          },
          "virtualNetworkDeploy": {
            "value": "[parameters('virtualNetworkDeploy')]"
          },
          "serviceEndpointList": {
            "value": "[variables('subnetServiceEndpointList')]"
          },
          "gatewaySubnetCount": {
            "value": "[parameters('gatewaySubnetCount')]"
          },
          "managementSubnetCount": {
            "value": "[parameters('managementSubnetCount')]"
          },
          "frontendSubnetCount": {
            "value": "[parameters('frontendSubnetCount')]"
          },
          "backendSubnetCount": {
            "value": "[parameters('backendSubnetCount')]"
          },
          "sharedWorkerSubnetCount": {
            "value": "[parameters('sharedWorkerSubnetCount')]"
          },
          "sharedSqlServerSubnetCount": {
            "value": "[parameters('sharedSqlServerSubnetCount')]"
          },
          "sharedKeyVaultSubnetCount": {
            "value": "[parameters('sharedKeyVaultSubnetCount')]"
          },
          "firewallsNsgName": {
            "value": "[parameters('firewallsNsgName')]"
          },
          "firewallsResourceGroup": {
            "value": "[variables('firewallsResourceGroup')]"
          }
        }
      }
    },
    {
      "apiVersion": "2017-05-10",
      "name": "get-subnet-resourceid-list",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('sharedDeploymentUrlBase'),'utilities/getSubnetResourceIdList.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "virtualNetworkName": {
            "value": "[variables('virtualNetworkName')]"
          },
          "subnetConfiguration": {
            "value": "[concat(reference(concat('virtual-network-west-europe-', variables('environmentName'))).outputs.backendSubnetConfiguration.value, reference(concat('virtual-network-west-europe-', variables('environmentName'))).outputs.frontendSubnetConfiguration.value)]"
          }
        }
      }
    },
    {
      "apiVersion": "2017-05-10",
      "name": "configuration-storage-account",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'storage-account-arm.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "storageAccountName": {
            "value": "[variables('configurationStorageName')]"
          },
          "allowSharedKeyAccess": {
            "value": true
          }
        }
      }
    },
    {
      "apiVersion": "2017-05-10",
      "name": "arm-shared-storage",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'storage-account-arm.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "storageAccountName": {
            "value": "[variables('sharedARMStorageName')]"
          },
          "allowSharedKeyAccess": {
            "value": true
          }
        }
      }
    },
    {
      "apiVersion": "2017-05-10",
      "name": "[concat('shared-storage-account-container', parameters('sharedStorageAccountContainerArray')[copyIndex()])]",
      "type": "Microsoft.Resources/deployments",
      "condition": "[greater(length(parameters('sharedStorageAccountContainerArray')), 0)]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'), 'storage-container.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "storageAccountName": {
            "value": "[variables('sharedARMStorageName')]"
          },
          "containerName": {
            "value": "[parameters('sharedStorageAccountContainerArray')[copyIndex()]]"
          },
          "publicAccess": {
            "value": "None"
          }
        }
      },
      "copy": {
        "name": "sharedstorageaccountcontainercopy",
        "count": "[length(parameters('sharedStorageAccountContainerArray'))]"
      },
      "dependsOn": [
        "arm-shared-storage"
      ]
    },
    {
      "apiVersion": "2017-05-10",
      "name": "sql-server-deployment",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'sql-server.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "sqlServerName": {
            "value": "[if(variables('deployFailoverGroups'), variables('primarySQLServerName'), variables('baseSQLServerName'))]"
          },
          "sqlServerLocation": {
            "value": "[variables('sqlServerLocationMap').primary.location]"
          },
          "sqlServerAdminUserName": {
            "value": "[concat('d', uniqueString(resourceGroup().id, guid(if(variables('deployFailoverGroups'), variables('primarySQLServerName'), variables('baseSQLServerName')))))]"
          },
          "sqlServerAdminPassword": {
            "reference": {
              "keyVault": {
                "id": "[resourceId(parameters('sharedManagementResourceGroup'), 'Microsoft.KeyVault/vaults', parameters('sharedKeyVaultName'))]"
              },
              "secretName": "[parameters('sqlServerAdminPasswordSecretName')]"
            }
          },
          "sqlServerActiveDirectoryAdminLogin": {
            "value": "[parameters('sqlServerActiveDirectoryAdminLogin')]"
          },
          "sqlServerActiveDirectoryAdminObjectId": {
            "value": "[parameters('sqlServerActiveDirectoryAdminObjectId')]"
          },
          "sqlServerMinimalTlsVersion": {
            "value": "[variables('sqlServerMinimalTlsVersion')]"
          },
          "threatDetectionEmailAddress": {
            "value": "[parameters('threatDetectionEmailAddress')]"
          },
          "sqlStorageAccountName": {
            "value": "[variables('sharedARMStorageName')]"
          }
        }
      },
      "dependsOn": [
        "arm-shared-storage"
      ]
    },
    {
      "apiVersion": "2017-05-10",
      "name": "sql-server-deployment-replica",
      "type": "Microsoft.Resources/deployments",
      "condition": "[variables('deployFailoverGroups')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'sql-server.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "sqlServerName": {
            "value": "[if(variables('deployFailoverGroups'), variables('secondarySQLServerName'), variables('baseSQLServerName'))]"
          },
          "sqlServerLocation": {
            "value": "[variables('sqlServerLocationMap').secondary.location]"
          },
          "sqlServerAdminUserName": {
            "value": "[concat('d', uniqueString(resourceGroup().id, guid(variables('secondarySQLServerName'))))]"
          },
          "sqlServerAdminPassword": {
            "reference": {
              "keyVault": {
                "id": "[resourceId(parameters('sharedManagementResourceGroup'), 'Microsoft.KeyVault/vaults', parameters('sharedKeyVaultName'))]"
              },
              "secretName": "[parameters('sqlServerAdminPasswordSecretName')]"
            }
          },
          "sqlServerActiveDirectoryAdminLogin": {
            "value": "[parameters('sqlServerActiveDirectoryAdminLogin')]"
          },
          "sqlServerActiveDirectoryAdminObjectId": {
            "value": "[parameters('sqlServerActiveDirectoryAdminObjectId')]"
          },
          "sqlServerMinimalTlsVersion": {
            "value": "[variables('sqlServerMinimalTlsVersion')]"
          },
          "threatDetectionEmailAddress": {
            "value": "[parameters('threatDetectionEmailAddress')]"
          },
          "sqlStorageAccountName": {
            "value": "[variables('sharedARMStorageName')]"
          }
        }
      },
      "dependsOn": [
        "arm-shared-storage"
      ]
    },
    {
      "apiVersion": "2017-05-10",
      "name": "sql-server-failover-group",
      "type": "Microsoft.Resources/deployments",
      "condition": "[variables('deployFailoverGroups')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'sql-server-failover-group.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "failoverGroupName": {
            "value": "[variables('baseSqlServerName')]"
          },
          "primarySqlServerName": {
            "value": "[variables('primarySQLServerName')]"
          },
          "secondarySqlServerName": {
            "value": "[variables('secondarySQLServerName')]"
          },
          "databases": {
            "value": "[parameters('databaseConfiguration')[toUpper(variables('environmentName'))].DatabaseResourceIds]"
          }
        }
      },
      "dependsOn": [
        "sql-server-deployment",
        "sql-server-deployment-replica"
      ]
    },
    {
      "apiVersion": "2017-05-10",
      "name": "front-end-app-service-plan",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'app-service-plan.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "appServicePlanName": {
            "value": "[variables('sharedFrontEndAppServicePlanName')]"
          },
          "aspSize": {
            "value": "[parameters('frontEndAppServicePlanSku').size]"
          },
          "aspInstances": {
            "value": "[parameters('frontEndAppServicePlanSku').instances]"
          },
          "nonASETier": {
            "value": "[parameters('frontEndAppServicePlanSku').tier]"
          }
        }
      }
    },
    {
      "apiVersion": "2017-05-10",
      "name": "back-end-app-service-plan",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'app-service-plan.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "appServicePlanName": {
            "value": "[variables('sharedBackEndAppServicePlanName')]"
          },
          "aspSize": {
            "value": "[parameters('backEndAppServicePlanSku').size]"
          },
          "aspInstances": {
            "value": "[parameters('backEndAppServicePlanSku').instances]"
          },
          "nonASETier": {
            "value": "[parameters('backEndAppServicePlanSku').tier]"
          }
        }
      }
    },
    {
      "apiVersion": "2017-05-10",
      "name": "shared-worker-app-service-plan",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'app-service-plan.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "appServicePlanName": {
            "value": "[variables('sharedWorkerAppServicePlanName')]"
          },
          "aspSize": {
            "value": "[parameters('sharedWorkerAppServicePlanSku').size]"
          },
          "aspInstances": {
            "value": "[parameters('sharedWorkerAppServicePlanSku').instances]"
          },
          "nonASETier": {
            "value": "[parameters('sharedWorkerAppServicePlanSku').tier]"
          }
        }
      }
    },
    {
      "apiVersion": "2017-05-10",
      "name": "service-bus",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'service-bus.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "serviceBusNamespaceName": {
            "value": "[variables('serviceBusNamespaceName')]"
          },
          "serviceBusQueues": {
            "value": [
              "deadletters"
            ]
          },
          "logAnalyticsWorkspaceName": {
            "value": "[parameters('logAnalyticsWorkspaceName')]"
          },
          "logAnalyticsWorkspaceResourceGroupName": {
            "value": "[parameters('logAnalyticsWorkspaceResourceGroupName')]"
          }
        }
      }
    },
    {
      "apiVersion": "2017-05-10",
      "name": "redis-cache",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'redis.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "redisCacheName": {
            "value": "[variables('redisCacheName')]"
          },
          "redisCacheSKU": {
            "value": "Standard"
          },
          "redisCacheFamily": {
            "value": "C"
          },
          "redisCacheCapacity": {
            "value": 1
          },
          "enableNonSslPort": {
            "value": false
          }
        }
      }
    },
    {
      "apiVersion": "2017-05-10",
      "name": "cdn-profile",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'cdn-profile.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "cdnProfileName": {
            "value": "[variables('cdnProfileName')]"
          },
          "cdnSKU": {
            "value": "Standard_Verizon"
          }
        }
      }
    },
    {
      "apiVersion": "2017-05-10",
      "name": "event-hub-namespace",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'event-hub-namespace.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "eventHubNamespaceName": {
            "value": "[variables('eventHubNamespaceName')]"
          },
          "eventHubTier": {
            "value": "Standard"
          },
          "eventHubCapacity": {
            "value": 1
          },
          "isAutoInflateEnabled": {
            "value": true
          },
          "maximumThroughputUnits": {
            "value": 20
          }
        }
      }
    },
    {
      "apiVersion": "2017-05-10",
      "name": "sql-server-private-dns-zone",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'private-dns-zone.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "dnsZoneName": {
            "value": "[variables('sqlServerPrivateDnsZoneName')]"
          },
          "vnetId": {
            "value": "[resourceId(resourceGroup().name, 'Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]"
          }
        }
      },
      "dependsOn": [
        "[concat('virtual-network-west-europe-', variables('environmentName'))]"
      ]
    },
    {
      "apiVersion": "2017-05-10",
      "name": "sql-server-private-endpoint",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'private-endpoint.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "privateEndpointName": {
            "value": "[concat(if(variables('deployFailoverGroups'), variables('primarySQLServerName'), variables('baseSQLServerName')),'-pe')]"
          },
          "subnetId": {
            "value": "[reference(concat('virtual-network-west-europe-', variables('environmentName'))).outputs.sharedSqlServerSubnetResourceId.value]"
          },
          "privateLinkGroupIds": {
            "value": ["sqlServer"]
          },
          "privateLinkServiceId": {
            "value": "[resourceId(resourceGroup().name,'Microsoft.Sql/servers',if(variables('deployFailoverGroups'), variables('primarySQLServerName'), variables('baseSQLServerName')))]"
          },
          "privateDnsZoneId": {
            "value": "[resourceId(resourceGroup().name,'Microsoft.Network/privateDnsZones',variables('sqlServerPrivateDnsZoneName'))]"
          }
        }
      },
      "dependsOn": [
        "sql-server-deployment",
        "[concat('virtual-network-west-europe-', variables('environmentName'))]",
        "sql-server-private-dns-zone"
      ]
    },
    {
      "apiVersion": "2017-05-10",
      "name": "replica-sql-server-private-endpoint",
      "type": "Microsoft.Resources/deployments",
      "condition": "[variables('deployFailoverGroups')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'private-endpoint.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "privateEndpointName": {
            "value": "[concat(variables('secondarySQLServerName'),'-pe')]"
          },
          "subnetId": {
            "value": "[reference(concat('virtual-network-west-europe-', variables('environmentName'))).outputs.sharedSqlServerSubnetResourceId.value]"
          },
          "privateLinkGroupIds": {
            "value": [ "sqlServer" ]
          },
          "privateLinkServiceId": {
            "value": "[resourceId(resourceGroup().name,'Microsoft.Sql/servers',variables('secondarySQLServerName'))]"
          },
          "privateDnsZoneId": {
            "value": "[resourceId(resourceGroup().name,'Microsoft.Network/privateDnsZones',variables('sqlServerPrivateDnsZoneName'))]"
          }
        }
      },
      "dependsOn": [
        "sql-server-deployment-replica",
        "[concat('virtual-network-west-europe-', variables('environmentName'))]",
        "sql-server-private-dns-zone"
      ]
    },
    {
      "apiVersion": "2021-04-01",
      "name": "[concat('external-sql-server-private-endpoint-', copyIndex('externalSqlServerPrivateEndpointsCopy'))]",
      "type": "Microsoft.Resources/deployments",
      "condition": "[greater(length(variables('envrionmentExternalSqlServerPrivateEndpoints')),0)]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'private-endpoint.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "privateEndpointName": {
            "value": "[variables('envrionmentExternalSqlServerPrivateEndpoints')[copyIndex()].sqlServerName]"
          },
          "subnetId": {
            "value": "[reference(concat('virtual-network-west-europe-', variables('environmentName'))).outputs.sharedSqlServerSubnetResourceId.value]"
          },
          "privateLinkGroupIds": {
            "value": [ "sqlServer" ]
          },
          "privateLinkServiceId": {
            "value": "[resourceId(variables('envrionmentExternalSqlServerPrivateEndpoints')[copyIndex()].subscriptionId,variables('envrionmentExternalSqlServerPrivateEndpoints')[copyIndex()].resourceGroup,'Microsoft.Sql/servers',variables('envrionmentExternalSqlServerPrivateEndpoints')[copyIndex()].sqlServerName)]"
          },
          "privateDnsZoneId": {
            "value": "[resourceId(resourceGroup().name,'Microsoft.Network/privateDnsZones',variables('sqlServerPrivateDnsZoneName'))]"
          },
          "manualApproval": {
            "value": true
          }
        }
      },
      "copy": {
        "name": "externalSqlServerPrivateEndpointsCopy",
        "count": "[length(variables('envrionmentExternalSqlServerPrivateEndpoints'))]"
      },
      "dependsOn": [
        "[concat('virtual-network-west-europe-', variables('environmentName'))]",
        "sql-server-private-dns-zone"
      ]
    },
    {
      "apiVersion": "2017-05-10",
      "name": "keyvault-private-dns-zone",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'private-dns-zone.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "dnsZoneName": {
            "value": "[variables('keyVaultPrivateDnsZoneName')]"
          },
          "vnetId": {
            "value": "[resourceId(resourceGroup().name, 'Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]"
          }
        }
      },
      "dependsOn": [
        "[concat('virtual-network-west-europe-', variables('environmentName'))]"
      ]
    },
    {
      "apiVersion": "2017-05-10",
      "name": "shared-keyvault-private-endpoint",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'private-endpoint.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "privateEndpointName": {
            "value": "[concat(parameters('sharedKeyVaultName'),'-pe')]"
          },
          "subnetId": {
            "value": "[reference(concat('virtual-network-west-europe-', variables('environmentName'))).outputs.sharedKeyVaultSubnetResourceId.value]"
          },
          "privateLinkGroupIds": {
            "value": [ "vault" ]
          },
          "privateLinkServiceId": {
            "value": "[resourceId(parameters('sharedManagementResourceGroup'),'Microsoft.KeyVault/vaults',parameters('sharedKeyVaultName'))]"
          },
          "privateDnsZoneId": {
            "value": "[resourceId(resourceGroup().name,'Microsoft.Network/privateDnsZones',variables('keyVaultPrivateDnsZoneName'))]"
          }
        }
      },
      "dependsOn": [
        "[concat('virtual-network-west-europe-', variables('environmentName'))]",
        "keyvault-private-dns-zone"
      ]
    }
  ],
  "outputs": {}
}

{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "resourceEnvironmentName": {
      "type": "string",
      "metadata": {
        "description": "Base environment name. E.g. DEV. PP, PRD, MO. ",
        "environmentVariable": "resourceEnvironmentName"
      }
    },
    "serviceName": {
      "type": "string",
      "defaultValue": "shared",
      "metadata": {
        "description": "Service name of the service. E.g shared infrastructure = shared.",
        "environmentVariable": "serviceName"
      }
    },
    "keyVaultSecretCertificateAccessObjectId": {
      "type": "string",
      "metadata": {
        "description": "Object Id of the Azure AD Object you want to grant Key Vault Secret and Certificate access to",
        "environmentVariable": "keyVaultSecretCertificateAccessObjectId"
      }
    },
    "keyVaultSecretAccessObjectIds": {
      "type": "array",
      "metadata": {
        "description": "Object Ids of the Azure AD Objects you want to grant Key Vault Secret access to",
        "environmentVariable": "keyVaultSecretAccessObjectIds"
      }
    },
    "microsoftAzureWebsitesRPObjectId": {
      "type": "string",
      "metadata": {
        "description": "Object Id of the Azure Websites RP",
        "environmentVariable": "microsoftAzureWebsitesRPObjectId"
      }
    },
    "backupManagementServiceObjectId": {
      "type": "string",
      "metadata": {
        "description": "Object Id for the backup management service",
        "environmentVariable": "backupManagementServiceObjectId"
      }
    },
    "diskEncryptionEnterpriseApplicationObjectId": {
      "type": "string",
      "metadata": {
        "description": "Object Id for the disk Encryption Enterprise Application",
        "environmentVariable": "diskEncryptionEnterpriseApplicationObjectId"
      }
    },
    "AKSEnterpriseApplicationObjectId": {
      "type": "string",
      "defaultValue": "Disabled",
      "metadata": {
        "description": "Object Id for the AKS Enterprise Application",
        "environmentVariable": "AKSEnterpriseApplicationObjectId"
      }
    },
    "AKSRouteTableName": {
      "type": "string",
      "defaultValue": "Disabled",
      "metadata": {
        "description": "Name of the AKS Route Table to be included in the DEV management subnet mgmt-sn-0",
        "environmentVariable": "AKSRouteTableName"
      }
    },
    "AKSRouteTableResourceGroupName": {
      "type": "string",
      "defaultValue": "Disabled",
      "metadata": {
        "description": "Name of the DEV Resource Group where the AKS Route Table resides, used for the resourceId function to get the AKS Route Table resource",
        "environmentVariable": "AKSRouteTableResourceGroupName"
      }
    },
    "FirewallNsg": {
      "type": "string",
      "defaultValue": "Disabled",
      "metadata": {
        "description": "Name of the Resource Group where the firewall NSG resides, used for the resourceId function to get the firewall NSG resource",
        "environmentVariable": "FirewallNsg"
      }
    },
    "FirewallResourceGroupName": {
      "type": "string",
      "defaultValue": "Disabled",
      "metadata": {
        "description": "Name of the firewall NSG to be associated to the gateway subnet gw-sn-0",
        "environmentVariable": "FirewallResourceGroupName"
      }
    },
    "environments": {
      "type": "array",
      "defaultValue": [
      ],
      "metadata": {
        "description": "String array of all environments in this subscription",
        "environmentVariable": "environmentNames"
      }
    },
    "sqlServerActiveDirectoryAdminLogin": {
      "type": "string",
      "metadata": {
        "description": "The active directory admin that will be assigned to the sql server",
        "environmentVariable": "sqlServerActiveDirectoryAdminLogin"
      }
    },
    "sqlServerActiveDirectoryAdminObjectId": {
      "type": "string",
      "metadata": {
        "description": "The object id of the active directory admin that will be assigned to the sql server",
        "environmentVariable": "sqlServerActiveDirectoryAdminObjectId"
      }
    },
    "threatDetectionEmailAddress": {
      "type": "string",
      "metadata": {
        "description": "The email address that threat alerts will be sent to",
        "environmentVariable": "threatDetectionEmailAddress"
      }
    },
    "databaseConfiguration": {
      "type": "object",
      "metadata": {
        "description": "Configuration object which describes the structure of failover groups",
        "environmentVariable": "databaseConfiguration"
      }
    },
    "gatewaySubnetCount": {
      "type": "int",
      "defaultValue": 0,
      "maxValue": 5,
      "metadata": {
        "description": "The number of gateway subnets to provision",
        "environmentVariable": "gatewaySubnetCount"
      }
    },
    "managementSubnetCount": {
      "type": "int",
      "defaultValue": 1,
      "maxValue": 50,
      "metadata": {
        "description": "The number of management subnets to provision",
        "environmentVariable": "managementSubnetCount"
      }
    },
    "externalAppSubnetCount": {
      "type": "int",
      "defaultValue": 0,
      "maxValue": 50,
      "metadata": {
        "description": "The number of external subnets to provision",
        "environmentVariable": "externalAppSubnetCount"
      }
    },
    "internalAppSubnetCount": {
      "type": "int",
      "defaultValue": 0,
      "maxValue": 150,
      "metadata": {
        "description": "The number of internal subnets to provision.",
        "environmentVariable": "internalAppSubnetCount"
      }
    },
    "sqlAdminPasswordSeed": {
      "type": "securestring",
      "metadata": {
        "description": "The seed used to generate passwords for sql server deployments.",
        "environmentVariable": "sqlAdminPasswordSeed"
      }
    },
    "frontEndAppServicePlanSku": {
      "type": "object",
      "defaultValue": {
        "tier": "Standard",
        "size": "2",
        "instances": 2
      },
      "metadata": {
        "description": "An object representing the sku of the app service plan.",
        "environmentVariable": "frontEndAppServicePlanSku"
      }
    },
    "backEndAppServicePlanSku": {
      "type": "object",
      "defaultValue": {
        "tier": "Standard",
        "size": "2",
        "instances": 2
      },
      "metadata": {
        "description": "An object representing the sku of the app service plan.",
        "environmentVariable": "backEndAppServicePlanSku"
      }
    },
    "sharedStorageAccountContainerArray": {
      "type": "array",
      "metadata": {
        "description": "An array of the blob container names to deploy to the shared storage account.",
        "environmentVariable": "sharedStorageAccountContainerArray"
      }
    }
  },
  "variables": {
    "deploymentUrlBase": "https://raw.githubusercontent.com/SkillsFundingAgency/das-platform-building-blocks/master/templates/",
    "sharedDeploymentUrlBase": "https://raw.githubusercontent.com/SkillsFundingAgency/das-shared-infrastructure/master/",
    "resourceNamePrefix": "[toLower(concat('das-', parameters('resourceEnvironmentName'),'-', parameters('serviceName')))]",
    "keyVaultName": "[concat(variables('resourceNamePrefix'),'-kv')]",
    "classicStorageName": "[concat(replace(variables('resourceNamePrefix'), '-',''), 'deploystr')]",
    "automationAccountName": "[concat(variables('resourceNamePrefix'),'-aa')]",
    "mgmtManagementSubnetCount": 1,
    "virtualNetworkName": "[concat(variables('resourceNamePrefix'),'-vnet')]",
    "AKSKeyVaultAccessPolicy": [
      {
        "objectId": "[parameters('AKSEnterpriseApplicationObjectId')]",
        "tenantId": "[subscription().tenantId]",
        "permissions": {
          "secrets": [
            "Get"
          ],
          "certificates": [
            "Get"
          ]
        }
      }
    ],
    "keyVaultAccessPolicies": [
      {
        "objectId": "[parameters('microsoftAzureWebsitesRPObjectId')]",
        "tenantId": "[subscription().tenantId]",
        "permissions": {
          "secrets": [
            "Get"
          ]
        }
      },
      {
        "objectId": "[parameters('backupManagementServiceObjectId')]",
        "tenantId": "[subscription().tenantId]",
        "permissions": {
          "keys": [
            "Get",
            "List",
            "Backup"
          ],
          "secrets": [
            "Get",
            "List",
            "Backup"
          ]
        }
      },
      {
        "objectId": "[parameters('diskEncryptionEnterpriseApplicationObjectId')]",
        "tenantId": "[subscription().tenantId]",
        "permissions": {
          "keys": [
            "WrapKey"
          ],
          "secrets": [
            "Set"
          ]
        }
      },
      {
        "objectId": "[parameters('keyVaultSecretCertificateAccessObjectId')]",
        "tenantId": "[subscription().tenantId]",
        "permissions": {
          "secrets": [
            "Get",
            "List",
            "Set"
          ],
          "certificates": [
            "Get",
            "List",
            "Create",
            "GetIssuers",
            "ListIssuers"
          ]
        }
      }
    ],
    "copy": [
      {
        "name": "parameterKeyVaultSecretAccessPolicies",
        "count": "[length(parameters('keyVaultSecretAccessObjectIds'))]",
        "input": {
          "objectId": "[parameters('keyVaultSecretAccessObjectIds')[copyIndex('parameterKeyVaultSecretAccessPolicies')]]",
          "tenantId": "[subscription().tenantId]",
          "permissions": {
            "secrets": [
              "Get",
              "List",
              "Set"
            ]
          }
        }
      }
    ]
  },
  "functions": [
    {
      "namespace": "blocks",
      "members": {
        "getPasswordFromSeed": {
          "parameters": [
            {
              "name": "seed",
              "type": "string"
            },
            {
              "name": "name",
              "type": "string"
            },
            {
              "name": "environment",
              "type": "string"
            }
          ],
          "output": {
            "type": "string",
            "value": "[concat(toUpper(substring(parameters('environment'),0,1)), uniqueString(resourceGroup().id, parameters('name'), parameters('seed')), toLower(parameters('environment')), '!')]"
          }
        }
      }
    }
  ],
  "resources": [
    {
      "apiVersion": "2017-05-10",
      "name": "[concat('virtual-network-west-europe-', variables('resourceNamePrefix'))]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('sharedDeploymentUrlBase'),'templates/network.template.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "virtualNetworkName": {
            "value": "[variables('virtualNetworkName')]"
          },
          "managementSubnetCount": {
            "value": "[variables('mgmtManagementSubnetCount')]"
          },
          "virtualNetworkAddressSpacePrefix": {
            "value": "10.0"
          },
          "AKSRouteTableName": {
            "value": "[parameters('AKSRouteTableName')]"
          },
          "AKSRouteTableResourceGroupName": {
            "value": "[parameters('AKSRouteTableResourceGroupName')]"
          },
          "FirewallResourceGroupName": {
            "value": "[parameters('FirewallResourceGroupName')]"
          },
          "FirewallNsg": {
            "value": "[parameters('FirewallNsg')]"
          }
        }
      }
    },
    {
      "apiVersion": "2017-05-10",
      "name": "key-vault",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'keyvault.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "keyVaultName": {
            "value": "[variables('keyVaultName')]"
          },
          "keyVaultAccessPolicies": {
            "value": "[if(equals(parameters('AKSEnterpriseApplicationObjectId'),'Disabled'),concat(variables('KeyVaultAccessPolicies'),variables('parameterKeyVaultSecretAccessPolicies')),concat(variables('KeyVaultAccessPolicies'),variables('parameterKeyVaultSecretAccessPolicies'),variables('AKSKeyVaultAccessPolicy')))]"
          },
          "enabledForDiskEncryption": {
            "value": true
          },
          "enabledForTemplateDeployment": {
            "value": true
          },
          "enableSoftDelete": {
            "value": true
          }
        }
      }
    },
    {
      "apiVersion": "2017-05-10",
      "name": "[concat('sql-server-key-vault-secrets-', parameters('environments')[copyIndex()])]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'keyvault-secret.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "keyVaultName": {
            "value": "[variables('keyVaultName')]"
          },
          "secretName": {
            "value": "[toLower(concat('das-', parameters('environments')[copyIndex()], '-shared-sql'))]"
          },
          "secretValue": {
            "value": "[blocks.getPasswordFromSeed(parameters('sqlAdminPasswordSeed'), toLower(concat('das-', parameters('environments')[copyIndex()], '-shared-sql')), uniqueString(parameters('environments')[copyIndex()]))]"
          }
        }
      },
      "copy": {
        "name": "secretsCopy",
        "count": "[length(parameters('environments'))]"
      },
      "dependsOn": [
        "key-vault"
      ]
    },
    {
      "apiVersion": "2017-05-10",
      "name": "classic-storage-account",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'storage-account-classic.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "storageAccountName": {
            "value": "[variables('classicStorageName')]"
          }
        }
      }
    },
    {
      "apiVersion": "2017-05-10",
      "name": "[toLower(concat(parameters('environments')[copyIndex()], '-shared-environment-infrastructure'))]",
      "type": "Microsoft.Resources/deployments",
      "resourceGroup": "[toLower(concat('das-', parameters('environments')[copyIndex()], '-shared-rg'))]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('sharedDeploymentUrlBase'), 'templates/environment.template.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "environmentName": {
            "value": "[toUpper(parameters('environments')[copyIndex()])]"
          },
          "sharedKeyVaultResourceGroup": {
            "value": "[resourceGroup().name]"
          },
          "sharedKeyVaultName": {
            "value": "[variables('keyVaultName')]"
          },
          "sharedKeyVaultId": {
            "value": "[reference('key-vault').outputs.KeyVaultResourceId.value]"
          },
          "sqlServerAdminPasswordSecretName": {
            "value": "[toLower(concat('das-', parameters('environments')[copyIndex()], '-shared-sql'))]"
          },
          "sqlServerActiveDirectoryAdminLogin": {
            "value": "[parameters('sqlServerActiveDirectoryAdminLogin')]"
          },
          "sqlServerActiveDirectoryAdminObjectId": {
            "value": "[parameters('sqlServerActiveDirectoryAdminObjectId')]"
          },
          "threatDetectionEmailAddress": {
            "value": "[parameters('threatDetectionEmailAddress')]"
          },
          "databaseConfiguration": {
            "value": "[parameters('databaseConfiguration')]"
          },
          "virtualNetworkAddressSpacePrefix": {
            "value": "[concat('10.', copyIndex(1))]"
          },
          "gatewaySubnetCount": {
            "value": "[parameters('gatewaySubnetCount')]"
          },
          "managementSubnetCount": {
            "value": "[parameters('managementSubnetCount')]"
          },
          "externalAppSubnetCount": {
            "value": "[parameters('externalAppSubnetCount')]"
          },
          "internalAppSubnetCount": {
            "value": "[parameters('internalAppSubnetCount')]"
          },
          "frontEndAppServicePlanSku": {
            "value": "[parameters('frontEndAppServicePlanSku')]"
          },
          "backEndAppServicePlanSku": {
            "value": "[parameters('backEndAppServicePlanSku')]"
          },
          "sharedStorageAccountContainerArray": {
            "value": "[parameters('sharedStorageAccountContainerArray')]"
          }
        }
      },
      "copy": {
        "name": "environmentCopy",
        "count": "[length(parameters('environments'))]"
      },
      "dependsOn": [
        "key-vault",
        "secretsCopy"
      ]
    },
    {
      "apiVersion": "2017-05-10",
      "name": "azure-automation",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'automation-account.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "automationAccountName": {
            "value": "[variables('automationAccountName')]"
          }
        }
      }
    }
  ],
  "outputs": {
  }
}
